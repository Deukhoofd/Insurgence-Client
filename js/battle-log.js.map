{"version":3,"sources":["../src/battle-log.ts"],"names":["BattleLog","elem","scene","innerElem","preemptElem","atBottom","skippedLines","className","battleParser","joinLeave","lastRename","perspective","onScroll","distanceFromBottom","scrollHeight","scrollTop","clientHeight","setAttribute","innerHTML","document","createElement","appendChild","BattleTextParser","onscroll","reset","destroy","addSeekEarlierButton","el","button","getElementsByTagName","addEventListener","e","preventDefault","battle","seekTurn","turn","addNode","add","args","kwArgs","preempt","silent","seeking","stepQueue","length","Infinity","currentStep","divClass","divHTML","noNotify","includes","name","message","rank","charAt","ignoreSpects","ignoreOpponent","toUserid","app","user","get","window","ignore","isHighlighted","rooms","roomid","getHighlight","parseChatMessage","notifyTitle","notifyOnce","parseNameParts","group","formattedUser","isJoin","joins","leaves","element","splice","indexOf","push","buf","textList","escapeHTML","toID","to","from","sanitizeHTML","changeUhtml","replace","parseMessage","addDiv","unlinkChatFrom","lineCount","parseInt","hideChatFrom","title","body","addBattleMessage","wait","ruleArgs","split","h2elem","turnMessage","parseArgs","trim","startsWith","endsWith","Error","slice","curLineSection","addSpacer","line","join","parseLogMessage","list","listNoDuplicates","i","messages","map","filter","sceneMessage","node","updateScroll","prependDiv","childNodes","insertBefore","id","htmlSrc","forceAdd","classContains","elements","parentElement","removeChild","userid","showRevealButton","classStart","nodes","style","display","value","lastNode","createTextNode","unlinkNodeList","nodeList","linkList","linkNode","parent","childNode","innerNodeList","preemptNodeList","preemptCatchup","firstChild","escapeFormat","formatid","atIndex","BattleFormats","NonBattleGames","str","jsEscapeToo","unescapeHTML","hashColor","usernameColor","colorCache","hash","Config","customcolors","MD5","H","substr","S","L","Math","floor","HSLToRGB","R","G","B","lum","HLmod","Hdist","min","abs","r","g","b","toHex","x","hex","round","toString","C","X","m","R1","G1","B1","prefs","Storage","PS","undefined","timestamp","showMe","hideme","test","colorStyle","clickableName","hlClass","isMine","mineClass","cmd","target","spaceIndex","parsedMessage","toRoomid","formatText","parts","isTrusted","options","hidelinks","hidespoiler","hidegreentext","initSanitizeHTML","tagPolicy","Object","assign","html4","ELEMENTS","marquee","blink","psicon","eflags","username","spotify","youtube","twitch","ATTRIBS","tagName","attribs","getAttrib","key","setAttrib","deleteAttrib","dataUri","targetReplace","src","location","protocol","channelId","exec","height","width","hostname","color","songId","innerWidth","videoId","time","iconType","iconValue","Dex","getPokemonIcon","getItemIcon","getTypeIcon","getCategoryIcon","html","sanitizeAttribs","urlData","scheme_","localizeTime","full","date","timezone","parsedTime","Date","toUpperCase","getTime","formattedTime","Intl","DateTimeFormat","month","day","hour","minute","format","toLocaleString","input","match","attrs","escapedUsername","sanitized","sanitizeWithPolicy","createReplayFile","room","replayid","server","registered","fragment","tier","p1","p2","routes","users","log","client","createReplayFileHref","encodeURIComponent","btoa","unescape","interstice","whitelist","patterns","entry","RegExp","isWhitelisted","uri","pattern","getURI","root"],"mappings":"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","sourcesContent":["/**\r\n * Battle log\r\n *\r\n * An exercise in minimalism! This is a dependency of the client, which\r\n * requires IE9+ and uses Preact, and the replay player, which requires\r\n * IE7+ and uses jQuery. Therefore, this has to be compatible with IE7+\r\n * and use the DOM directly!\r\n *\r\n * Special thanks to PPK for QuirksMode.org, one of the few resources\r\n * available for how to do web development in these conditions.\r\n *\r\n * @author Guangcong Luo <guangcongluo@gmail.com>\r\n * @license MIT\r\n */\r\n\r\nimport type {BattleScene} from './battle-animations';\r\n\r\n// Caja\r\ndeclare const html4: any;\r\ndeclare const html: any;\r\n\r\n// defined in battle-log-misc\r\ndeclare function MD5(input: string): string;\r\ndeclare function formatText(input: string, isTrusted?: boolean): string;\r\n\r\nexport class BattleLog {\r\n\telem: HTMLDivElement;\r\n\tinnerElem: HTMLDivElement;\r\n\tscene: BattleScene | null = null;\r\n\tpreemptElem: HTMLDivElement = null!;\r\n\tatBottom = true;\r\n\tskippedLines = false;\r\n\tclassName: string;\r\n\tbattleParser: BattleTextParser | null = null;\r\n\tjoinLeave: {\r\n\t\tjoins: string[],\r\n\t\tleaves: string[],\r\n\t\telement: HTMLDivElement,\r\n\t} | null = null;\r\n\tlastRename: {\r\n\t\tfrom: string,\r\n\t\tto: string,\r\n\t\telement: HTMLDivElement,\r\n\t} | null = null;\r\n\t/**\r\n\t * * -1 = spectator: \"Red sent out Pikachu!\" \"Blue's Eevee used Tackle!\"\r\n\t * * 0 = player 1: \"Go! Pikachu!\" \"The opposing Eevee used Tackle!\"\r\n\t * * 1 = player 2: \"Red sent out Pikachu!\" \"Eevee used Tackle!\"\r\n\t */\r\n\tperspective: -1 | 0 | 1 = -1;\r\n\tconstructor(elem: HTMLDivElement, scene?: BattleScene | null, innerElem?: HTMLDivElement) {\r\n\t\tthis.elem = elem;\r\n\r\n\t\tif (!innerElem) {\r\n\t\t\telem.setAttribute('role', 'log');\r\n\t\t\telem.innerHTML = '';\r\n\t\t\tinnerElem = document.createElement('div');\r\n\t\t\tinnerElem.className = 'inner message-log';\r\n\t\t\telem.appendChild(innerElem);\r\n\t\t}\r\n\t\tthis.innerElem = innerElem;\r\n\r\n\t\tif (scene) {\r\n\t\t\tthis.scene = scene;\r\n\t\t\tconst preemptElem = document.createElement('div');\r\n\t\t\tpreemptElem.className = 'inner-preempt message-log';\r\n\t\t\telem.appendChild(preemptElem);\r\n\t\t\tthis.preemptElem = preemptElem;\r\n\t\t\tthis.battleParser = new BattleTextParser();\r\n\t\t}\r\n\r\n\t\tthis.className = elem.className;\r\n\t\telem.onscroll = this.onScroll;\r\n\t}\r\n\tonScroll = () => {\r\n\t\tconst distanceFromBottom = this.elem.scrollHeight - this.elem.scrollTop - this.elem.clientHeight;\r\n\t\tthis.atBottom = (distanceFromBottom < 30);\r\n\t};\r\n\treset() {\r\n\t\tthis.innerElem.innerHTML = '';\r\n\t\tthis.atBottom = true;\r\n\t\tthis.skippedLines = false;\r\n\t}\r\n\tdestroy() {\r\n\t\tthis.elem.onscroll = null;\r\n\t}\r\n\taddSeekEarlierButton() {\r\n\t\tif (this.skippedLines) return;\r\n\t\tthis.skippedLines = true;\r\n\t\tconst el = document.createElement('div');\r\n\t\tel.className = 'chat';\r\n\t\tel.innerHTML = '<button class=\"button earlier-button\"><i class=\"fa fa-caret-up\"></i><br />Earlier messages</button>';\r\n\t\tconst button = el.getElementsByTagName('button')[0];\r\n\t\tbutton?.addEventListener?.('click', e => {\r\n\t\t\te.preventDefault();\r\n\t\t\tthis.scene?.battle.seekTurn(this.scene.battle.turn - 100);\r\n\t\t});\r\n\t\tthis.addNode(el);\r\n\t}\r\n\tadd(args: Args, kwArgs?: KWArgs, preempt?: boolean) {\r\n\t\tif (kwArgs?.silent) return;\r\n\t\tif (this.scene?.battle.seeking) {\r\n\t\t\tconst battle = this.scene.battle;\r\n\t\t\tif (battle.stepQueue.length > 2000) {\r\n\t\t\t\t// adding elements gets slower and slower the more there are\r\n\t\t\t\t// (so showing 100 turns takes around 2 seconds, and 1000 turns takes around a minute)\r\n\t\t\t\t// capping at 100 turns makes everything _reasonably_ snappy\r\n\t\t\t\tif (\r\n\t\t\t\t\tbattle.seeking === Infinity ?\r\n\t\t\t\t\t\tbattle.currentStep < battle.stepQueue.length - 2000 :\r\n\t\t\t\t\t\tbattle.turn < battle.seeking! - 100\r\n\t\t\t\t) {\r\n\t\t\t\t\tthis.addSeekEarlierButton();\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tlet divClass = 'chat';\r\n\t\tlet divHTML = '';\r\n\t\tlet noNotify: boolean | undefined;\r\n\t\tif (!['join', 'j', 'leave', 'l'].includes(args[0])) this.joinLeave = null;\r\n\t\tif (!['name', 'n'].includes(args[0])) this.lastRename = null;\r\n\t\tswitch (args[0]) {\r\n\t\tcase 'chat': case 'c': case 'c:':\r\n\t\t\tlet battle = this.scene?.battle;\r\n\t\t\tlet name;\r\n\t\t\tlet message;\r\n\t\t\tif (args[0] === 'c:') {\r\n\t\t\t\tname = args[2];\r\n\t\t\t\tmessage = args[3];\r\n\t\t\t} else {\r\n\t\t\t\tname = args[1];\r\n\t\t\t\tmessage = args[2];\r\n\t\t\t}\r\n\t\t\tlet rank = name.charAt(0);\r\n\t\t\tif (battle?.ignoreSpects && ' +'.includes(rank)) return;\r\n\t\t\tif (battle?.ignoreOpponent) {\r\n\t\t\t\tif ('\\u2605\\u2606'.includes(rank) && toUserid(name) !== app.user.get('userid')) return;\r\n\t\t\t}\r\n\t\t\tif (window.app?.ignore?.[toUserid(name)] && ' +\\u2605\\u2606'.includes(rank)) return;\r\n\t\t\tlet isHighlighted = window.app?.rooms?.[battle!.roomid].getHighlight(message);\r\n\t\t\t[divClass, divHTML, noNotify] = this.parseChatMessage(message, name, '', isHighlighted);\r\n\t\t\tif (!noNotify && isHighlighted) {\r\n\t\t\t\tlet notifyTitle = \"Mentioned by \" + name + \" in \" + battle!.roomid;\r\n\t\t\t\tapp.rooms[battle!.roomid].notifyOnce(notifyTitle, \"\\\"\" + message + \"\\\"\", 'highlight');\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\r\n\t\tcase 'join': case 'j': case 'leave': case 'l': {\r\n\t\t\tconst user = BattleTextParser.parseNameParts(args[1]);\r\n\t\t\tif (battle?.ignoreSpects && ' +'.includes(user.group)) return;\r\n\t\t\tconst formattedUser = user.group + user.name;\r\n\t\t\tconst isJoin = (args[0].charAt(0) === 'j');\r\n\t\t\tif (!this.joinLeave) {\r\n\t\t\t\tthis.joinLeave = {\r\n\t\t\t\t\tjoins: [],\r\n\t\t\t\t\tleaves: [],\r\n\t\t\t\t\telement: document.createElement('div'),\r\n\t\t\t\t};\r\n\t\t\t\tthis.joinLeave.element.className = 'chat';\r\n\t\t\t}\r\n\r\n\t\t\tif (isJoin && this.joinLeave.leaves.includes(formattedUser)) {\r\n\t\t\t\tthis.joinLeave.leaves.splice(this.joinLeave.leaves.indexOf(formattedUser), 1);\r\n\t\t\t} else {\r\n\t\t\t\tthis.joinLeave[isJoin ? \"joins\" : \"leaves\"].push(formattedUser);\r\n\t\t\t}\r\n\r\n\t\t\tlet buf = '';\r\n\t\t\tif (this.joinLeave.joins.length) {\r\n\t\t\t\tbuf += `${this.textList(this.joinLeave.joins)} joined`;\r\n\t\t\t}\r\n\t\t\tif (this.joinLeave.leaves.length) {\r\n\t\t\t\tif (this.joinLeave.joins.length) buf += `; `;\r\n\t\t\t\tbuf += `${this.textList(this.joinLeave.leaves)} left`;\r\n\t\t\t}\r\n\t\t\tthis.joinLeave.element.innerHTML = `<small>${BattleLog.escapeHTML(buf)}</small>`;\r\n\t\t\t(preempt ? this.preemptElem : this.innerElem).appendChild(this.joinLeave.element);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tcase 'name': case 'n': {\r\n\t\t\tconst user = BattleTextParser.parseNameParts(args[1]);\r\n\t\t\tif (toID(args[2]) === toID(user.name)) return;\r\n\t\t\tif (!this.lastRename || toID(this.lastRename.to) !== toID(user.name)) {\r\n\t\t\t\tthis.lastRename = {\r\n\t\t\t\t\tfrom: args[2],\r\n\t\t\t\t\tto: '',\r\n\t\t\t\t\telement: document.createElement('div'),\r\n\t\t\t\t};\r\n\t\t\t\tthis.lastRename.element.className = 'chat';\r\n\t\t\t}\r\n\t\t\tthis.lastRename.to = user.group + user.name;\r\n\t\t\tthis.lastRename.element.innerHTML = `<small>${BattleLog.escapeHTML(this.lastRename.to)} renamed from ${BattleLog.escapeHTML(this.lastRename.from)}.</small>`;\r\n\t\t\t(preempt ? this.preemptElem : this.innerElem).appendChild(this.lastRename.element);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tcase 'chatmsg': case '':\r\n\t\t\tdivHTML = BattleLog.escapeHTML(args[1]);\r\n\t\t\tbreak;\r\n\r\n\t\tcase 'chatmsg-raw': case 'raw': case 'html':\r\n\t\t\tdivHTML = BattleLog.sanitizeHTML(args[1]);\r\n\t\t\tbreak;\r\n\r\n\t\tcase 'uhtml': case 'uhtmlchange':\r\n\t\t\tthis.changeUhtml(args[1], args[2], args[0] === 'uhtml');\r\n\t\t\treturn ['', ''];\r\n\r\n\t\tcase 'error': case 'inactive': case 'inactiveoff':\r\n\t\t\tdivClass = 'chat message-error';\r\n\t\t\tdivHTML = BattleLog.escapeHTML(args[1]);\r\n\t\t\tbreak;\r\n\r\n\t\tcase 'bigerror':\r\n\t\t\tthis.message('<div class=\"broadcast-red\">' + BattleLog.escapeHTML(args[1]).replace(/\\|/g, '<br />') + '</div>');\r\n\t\t\treturn;\r\n\r\n\t\tcase 'pm':\r\n\t\t\tdivHTML = '<strong>' + BattleLog.escapeHTML(args[1]) + ':</strong> <span class=\"message-pm\"><i style=\"cursor:pointer\" onclick=\"selectTab(\\'lobby\\');rooms.lobby.popupOpen(\\'' + BattleLog.escapeHTML(args[2], true) + '\\')\">(Private to ' + BattleLog.escapeHTML(args[3]) + ')</i> ' + BattleLog.parseMessage(args[4]) + '</span>';\r\n\t\t\tbreak;\r\n\r\n\t\tcase 'askreg':\r\n\t\t\tthis.addDiv('chat', '<div class=\"broadcast-blue\"><b>Register an account to protect your ladder rating!</b><br /><button name=\"register\" value=\"' + BattleLog.escapeHTML(args[1]) + '\"><b>Register</b></button></div>');\r\n\t\t\treturn;\r\n\r\n\t\tcase 'unlink': {\r\n\t\t\t// |unlink| is deprecated in favor of |hidelines|\r\n\t\t\tconst user = toID(args[2]) || toID(args[1]);\r\n\t\t\tthis.unlinkChatFrom(user);\r\n\t\t\tif (args[2]) {\r\n\t\t\t\tconst lineCount = parseInt(args[3], 10);\r\n\t\t\t\tthis.hideChatFrom(user, true, lineCount);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tcase 'hidelines': {\r\n\t\t\tconst user = toID(args[2]);\r\n\t\t\tthis.unlinkChatFrom(user);\r\n\t\t\tif (args[1] !== 'unlink') {\r\n\t\t\t\tconst lineCount = parseInt(args[3], 10);\r\n\t\t\t\tthis.hideChatFrom(user, args[1] === 'hide', lineCount);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tcase 'debug':\r\n\t\t\tdivClass = 'debug';\r\n\t\t\tdivHTML = '<div class=\"chat\"><small style=\"color:#999\">[DEBUG] ' + BattleLog.escapeHTML(args[1]) + '.</small></div>';\r\n\t\t\tbreak;\r\n\r\n\t\tcase 'notify':\r\n\t\t\tconst title = args[1];\r\n\t\t\tconst body = args[2];\r\n\t\t\tconst roomid = this.scene?.battle.roomid;\r\n\t\t\tif (!roomid) break;\r\n\t\t\tapp.rooms[roomid].notifyOnce(title, body, 'highlight');\r\n\t\t\tbreak;\r\n\r\n\t\tcase 'seed': case 'choice': case ':': case 'timer': case 't:':\r\n\t\tcase 'J': case 'L': case 'N': case 'spectator': case 'spectatorleave':\r\n\t\tcase 'initdone':\r\n\t\t\treturn;\r\n\r\n\t\tdefault:\r\n\t\t\tthis.addBattleMessage(args, kwArgs);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (divHTML) this.addDiv(divClass, divHTML, preempt);\r\n\t}\r\n\taddBattleMessage(args: Args, kwArgs?: KWArgs) {\r\n\t\tswitch (args[0]) {\r\n\t\tcase 'warning':\r\n\t\t\tthis.message('<strong>Warning:</strong> ' + BattleLog.escapeHTML(args[1]));\r\n\t\t\tthis.message(`Bug? Report it to <a href=\"http://www.smogon.com/forums/showthread.php?t=3453192\">the replay viewer's Smogon thread</a>`);\r\n\t\t\tif (this.scene) this.scene.wait(1000);\r\n\t\t\treturn;\r\n\r\n\t\tcase 'variation':\r\n\t\t\tthis.addDiv('', '<small>Variation: <em>' + BattleLog.escapeHTML(args[1]) + '</em></small>');\r\n\t\t\tbreak;\r\n\r\n\t\tcase 'rule':\r\n\t\t\tconst ruleArgs = args[1].split(': ');\r\n\t\t\tthis.addDiv('', '<small><em>' + BattleLog.escapeHTML(ruleArgs[0]) + (ruleArgs[1] ? ':' : '') + '</em> ' + BattleLog.escapeHTML(ruleArgs[1] || '') + '</small>');\r\n\t\t\tbreak;\r\n\r\n\t\tcase 'rated':\r\n\t\t\tthis.addDiv('rated', '<strong>' + (BattleLog.escapeHTML(args[1]) || 'Rated battle') + '</strong>');\r\n\t\t\tbreak;\r\n\r\n\t\tcase 'tier':\r\n\t\t\tthis.addDiv('', '<small>Format:</small> <br /><strong>' + BattleLog.escapeHTML(args[1]) + '</strong>');\r\n\t\t\tbreak;\r\n\r\n\t\tcase 'turn':\r\n\t\t\tconst h2elem = document.createElement('h2');\r\n\t\t\th2elem.className = 'battle-history';\r\n\t\t\tlet turnMessage;\r\n\t\t\tif (this.battleParser) {\r\n\t\t\t\tturnMessage = this.battleParser.parseArgs(args, {}).trim();\r\n\t\t\t\tif (!turnMessage.startsWith('==') || !turnMessage.endsWith('==')) {\r\n\t\t\t\t\tthrow new Error(\"Turn message must be a heading.\");\r\n\t\t\t\t}\r\n\t\t\t\tturnMessage = turnMessage.slice(2, -2).trim();\r\n\t\t\t\tthis.battleParser.curLineSection = 'break';\r\n\t\t\t} else {\r\n\t\t\t\tturnMessage = `Turn ${args[1]}`;\r\n\t\t\t}\r\n\t\t\th2elem.innerHTML = BattleLog.escapeHTML(turnMessage);\r\n\t\t\tthis.addSpacer();\r\n\t\t\tthis.addNode(h2elem);\r\n\t\t\tbreak;\r\n\r\n\t\tdefault:\r\n\t\t\tlet line = null;\r\n\t\t\tif (this.battleParser) {\r\n\t\t\t\tline = this.battleParser.parseArgs(args, kwArgs || {}, true);\r\n\t\t\t}\r\n\t\t\tif (line === null) {\r\n\t\t\t\tthis.addDiv('chat message-error', 'Unrecognized: |' + BattleLog.escapeHTML(args.join('|')));\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif (!line) return;\r\n\t\t\tthis.message(...this.parseLogMessage(line));\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\ttextList(list: string[]) {\r\n\t\tlet message = '';\r\n\t\tconst listNoDuplicates: string[] = [];\r\n\t\tfor (const user of list) {\r\n\t\t\tif (!listNoDuplicates.includes(user)) listNoDuplicates.push(user);\r\n\t\t}\r\n\t\tlist = listNoDuplicates;\r\n\r\n\t\tif (list.length === 1) return list[0];\r\n\t\tif (list.length === 2) return `${list[0]} and ${list[1]}`;\r\n\t\tfor (let i = 0; i < list.length - 1; i++) {\r\n\t\t\tif (i >= 5) {\r\n\t\t\t\treturn `${message}and ${list.length - 5} others`;\r\n\t\t\t}\r\n\t\t\tmessage += `${list[i]}, `;\r\n\t\t}\r\n\t\treturn `${message}and ${list[list.length - 1]}`;\r\n\t\treturn message;\r\n\t}\r\n\t/**\r\n\t * To avoid trolling with nicknames, we can't just run this through\r\n\t * parseMessage\r\n\t */\r\n\tparseLogMessage(message: string): [string, string] {\r\n\t\tconst messages = message.split('\\n').map(line => {\r\n\t\t\tline = BattleLog.escapeHTML(line);\r\n\t\t\tline = line.replace(/\\*\\*(.*)\\*\\*/, '<strong>$1</strong>');\r\n\t\t\tline = line.replace(/\\|\\|([^\\|]*)\\|\\|([^\\|]*)\\|\\|/, '<abbr title=\"$1\">$2</abbr>');\r\n\t\t\tif (line.startsWith('  ')) line = '<small>' + line.trim() + '</small>';\r\n\t\t\treturn line;\r\n\t\t});\r\n\t\treturn [\r\n\t\t\tmessages.join('<br />'),\r\n\t\t\tmessages.filter(line => !line.startsWith('<small>[')).join('<br />'),\r\n\t\t];\r\n\t}\r\n\tmessage(message: string, sceneMessage = message) {\r\n\t\tif (this.scene) this.scene.message(sceneMessage);\r\n\t\tthis.addDiv('battle-history', message);\r\n\t}\r\n\taddNode(node: HTMLElement, preempt?: boolean) {\r\n\t\t(preempt ? this.preemptElem : this.innerElem).appendChild(node);\r\n\t\tif (this.atBottom) {\r\n\t\t\tthis.elem.scrollTop = this.elem.scrollHeight;\r\n\t\t}\r\n\t}\r\n\tupdateScroll() {\r\n\t\tif (this.atBottom) {\r\n\t\t\tthis.elem.scrollTop = this.elem.scrollHeight;\r\n\t\t}\r\n\t}\r\n\taddDiv(className: string, innerHTML: string, preempt?: boolean) {\r\n\t\tconst el = document.createElement('div');\r\n\t\tel.className = className;\r\n\t\tel.innerHTML = innerHTML;\r\n\t\tthis.addNode(el, preempt);\r\n\t}\r\n\tprependDiv(className: string, innerHTML: string, preempt?: boolean) {\r\n\t\tconst el = document.createElement('div');\r\n\t\tel.className = className;\r\n\t\tel.innerHTML = innerHTML;\r\n\t\tif (this.innerElem.childNodes.length) {\r\n\t\t\tthis.innerElem.insertBefore(el, this.innerElem.childNodes[0]);\r\n\t\t} else {\r\n\t\t\tthis.innerElem.appendChild(el);\r\n\t\t}\r\n\t\tthis.updateScroll();\r\n\t}\r\n\taddSpacer() {\r\n\t\tthis.addDiv('spacer battle-history', '<br />');\r\n\t}\r\n\tchangeUhtml(id: string, htmlSrc: string, forceAdd?: boolean) {\r\n\t\tid = toID(id);\r\n\t\tconst classContains = ' uhtml-' + id + ' ';\r\n\t\tlet elements = [] as HTMLDivElement[];\r\n\t\tfor (const node of this.innerElem.childNodes as any) {\r\n\t\t\tif (node.className && (' ' + node.className + ' ').includes(classContains)) {\r\n\t\t\t\telements.push(node);\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (this.preemptElem) {\r\n\t\t\tfor (const node of this.preemptElem.childNodes as any) {\r\n\t\t\t\tif (node.className && (' ' + node.className + ' ').includes(classContains)) {\r\n\t\t\t\t\telements.push(node);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (htmlSrc && elements.length && !forceAdd) {\r\n\t\t\tfor (const element of elements) {\r\n\t\t\t\telement.innerHTML = BattleLog.sanitizeHTML(htmlSrc);\r\n\t\t\t}\r\n\t\t\tthis.updateScroll();\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tfor (const element of elements) {\r\n\t\t\telement.parentElement!.removeChild(element);\r\n\t\t}\r\n\t\tif (!htmlSrc) return;\r\n\t\tif (forceAdd) {\r\n\t\t\tthis.addDiv('notice uhtml-' + id, BattleLog.sanitizeHTML(htmlSrc));\r\n\t\t} else {\r\n\t\t\tthis.prependDiv('notice uhtml-' + id, BattleLog.sanitizeHTML(htmlSrc));\r\n\t\t}\r\n\t}\r\n\thideChatFrom(userid: ID, showRevealButton = true, lineCount = 0) {\r\n\t\tconst classStart = 'chat chatmessage-' + userid + ' ';\r\n\t\tlet nodes: HTMLElement[] = [];\r\n\t\tfor (const node of this.innerElem.childNodes as any as HTMLElement[]) {\r\n\t\t\tif (node.className && (node.className + ' ').startsWith(classStart)) {\r\n\t\t\t\tnodes.push(node);\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (this.preemptElem) {\r\n\t\t\tfor (const node of this.preemptElem.childNodes as any as HTMLElement[]) {\r\n\t\t\t\tif (node.className && (node.className + ' ').startsWith(classStart)) {\r\n\t\t\t\t\tnodes.push(node);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (lineCount) nodes = nodes.slice(-lineCount);\r\n\r\n\t\tfor (const node of nodes) {\r\n\t\t\tnode.style.display = 'none';\r\n\t\t\tnode.className = 'revealed ' + node.className;\r\n\t\t}\r\n\t\tif (!nodes.length || !showRevealButton) return;\r\n\t\tconst button = document.createElement('button');\r\n\t\tbutton.name = 'toggleMessages';\r\n\t\tbutton.value = userid;\r\n\t\tbutton.className = 'subtle';\r\n\t\tbutton.innerHTML = `<small>(${nodes.length} line${nodes.length > 1 ? 's' : ''} from ${userid} hidden)</small>`;\r\n\t\tconst lastNode = nodes[nodes.length - 1];\r\n\t\tlastNode.appendChild(document.createTextNode(' '));\r\n\t\tlastNode.appendChild(button);\r\n\t}\r\n\r\n\tstatic unlinkNodeList(nodeList: ArrayLike<HTMLElement>, classStart: string) {\r\n\t\tfor (const node of nodeList as HTMLElement[]) {\r\n\t\t\tif (node.className && (node.className + ' ').startsWith(classStart)) {\r\n\t\t\t\tconst linkList = node.getElementsByTagName('a');\r\n\t\t\t\t// iterate in reverse because linkList will update as links are removed\r\n\t\t\t\tfor (let i = linkList.length - 1; i >= 0; i--) {\r\n\t\t\t\t\tconst linkNode = linkList[i];\r\n\t\t\t\t\tconst parent = linkNode.parentElement;\r\n\t\t\t\t\tif (!parent) continue;\r\n\t\t\t\t\tfor (const childNode of linkNode.childNodes as any) {\r\n\t\t\t\t\t\tparent.insertBefore(childNode, linkNode);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tparent.removeChild(linkNode);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tunlinkChatFrom(userid: ID) {\r\n\t\tconst classStart = 'chat chatmessage-' + userid + ' ';\r\n\t\tconst innerNodeList = this.innerElem.childNodes;\r\n\t\tBattleLog.unlinkNodeList(innerNodeList as NodeListOf<HTMLElement>, classStart);\r\n\r\n\t\tif (this.preemptElem) {\r\n\t\t\tconst preemptNodeList = this.preemptElem.childNodes;\r\n\t\t\tBattleLog.unlinkNodeList(preemptNodeList as NodeListOf<HTMLElement>, classStart);\r\n\t\t}\r\n\t}\r\n\r\n\tpreemptCatchup() {\r\n\t\tif (!this.preemptElem.firstChild) return;\r\n\t\tthis.innerElem.appendChild(this.preemptElem.firstChild);\r\n\t}\r\n\r\n\tstatic escapeFormat(formatid: string): string {\r\n\t\tlet atIndex = formatid.indexOf('@@@');\r\n\t\tif (atIndex >= 0) {\r\n\t\t\treturn this.escapeFormat(formatid.slice(0, atIndex)) +\r\n\t\t\t\t'<br />Custom rules: ' + this.escapeHTML(formatid.slice(atIndex + 3));\r\n\t\t}\r\n\t\tif (window.BattleFormats && BattleFormats[formatid]) {\r\n\t\t\treturn this.escapeHTML(BattleFormats[formatid].name);\r\n\t\t}\r\n\t\tif (window.NonBattleGames && NonBattleGames[formatid]) {\r\n\t\t\treturn this.escapeHTML(NonBattleGames[formatid]);\r\n\t\t}\r\n\t\treturn this.escapeHTML(formatid);\r\n\t}\r\n\r\n\tstatic escapeHTML(str: string, jsEscapeToo?: boolean) {\r\n\t\tif (typeof str !== 'string') return '';\r\n\t\tstr = str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\r\n\t\tif (jsEscapeToo) str = str.replace(/\\\\/g, '\\\\\\\\').replace(/'/g, '\\\\\\'');\r\n\t\treturn str;\r\n\t}\r\n\r\n\tstatic unescapeHTML(str: string) {\r\n\t\tstr = (str ? '' + str : '');\r\n\t\treturn str.replace(/&quot;/g, '\"').replace(/&gt;/g, '>').replace(/&lt;/g, '<').replace(/&amp;/g, '&');\r\n\t}\r\n\r\n\tstatic colorCache: {[userid: string]: string} = {};\r\n\r\n\t/** @deprecated */\r\n\tstatic hashColor(name: ID) {\r\n\t\treturn `color:${this.usernameColor(name)};`;\r\n\t}\r\n\r\n\tstatic usernameColor(name: ID) {\r\n\t\tif (this.colorCache[name]) return this.colorCache[name];\r\n\t\tlet hash;\r\n\t\tif (Config.customcolors[name]) {\r\n\t\t\thash = MD5(Config.customcolors[name]);\r\n\t\t} else {\r\n\t\t\thash = MD5(name);\r\n\t\t}\r\n\t\tlet H = parseInt(hash.substr(4, 4), 16) % 360; // 0 to 360\r\n\t\tlet S = parseInt(hash.substr(0, 4), 16) % 50 + 40; // 40 to 89\r\n\t\tlet L = Math.floor(parseInt(hash.substr(8, 4), 16) % 20 + 30); // 30 to 49\r\n\r\n\t\tlet {R, G, B} = this.HSLToRGB(H, S, L);\r\n\t\tlet lum = R * R * R * 0.2126 + G * G * G * 0.7152 + B * B * B * 0.0722; // 0.013 (dark blue) to 0.737 (yellow)\r\n\r\n\t\tlet HLmod = (lum - 0.2) * -150; // -80 (yellow) to 28 (dark blue)\r\n\t\tif (HLmod > 18) HLmod = (HLmod - 18) * 2.5;\r\n\t\telse if (HLmod < 0) HLmod = (HLmod - 0) / 3;\r\n\t\telse HLmod = 0;\r\n\t\t// let mod = ';border-right: ' + Math.abs(HLmod) + 'px solid ' + (HLmod > 0 ? 'red' : '#0088FF');\r\n\t\tlet Hdist = Math.min(Math.abs(180 - H), Math.abs(240 - H));\r\n\t\tif (Hdist < 15) {\r\n\t\t\tHLmod += (15 - Hdist) / 3;\r\n\t\t}\r\n\r\n\t\tL += HLmod;\r\n\r\n\t\tlet {R: r, G: g, B: b} = this.HSLToRGB(H, S, L);\r\n\t\tconst toHex = (x: number) => {\r\n\t\t\tconst hex = Math.round(x * 255).toString(16);\r\n\t\t\treturn hex.length === 1 ? '0' + hex : hex;\r\n\t\t};\r\n\t\tthis.colorCache[name] = `#${toHex(r)}${toHex(g)}${toHex(b)}`;\r\n\t\treturn this.colorCache[name];\r\n\t}\r\n\r\n\tstatic HSLToRGB(H: number, S: number, L: number) {\r\n\t\tlet C = (100 - Math.abs(2 * L - 100)) * S / 100 / 100;\r\n\t\tlet X = C * (1 - Math.abs((H / 60) % 2 - 1));\r\n\t\tlet m = L / 100 - C / 2;\r\n\r\n\t\tlet R1;\r\n\t\tlet G1;\r\n\t\tlet B1;\r\n\t\tswitch (Math.floor(H / 60)) {\r\n\t\tcase 1: R1 = X; G1 = C; B1 = 0; break;\r\n\t\tcase 2: R1 = 0; G1 = C; B1 = X; break;\r\n\t\tcase 3: R1 = 0; G1 = X; B1 = C; break;\r\n\t\tcase 4: R1 = X; G1 = 0; B1 = C; break;\r\n\t\tcase 5: R1 = C; G1 = 0; B1 = X; break;\r\n\t\tcase 0: default: R1 = C; G1 = X; B1 = 0; break;\r\n\t\t}\r\n\t\tlet R = R1 + m;\r\n\t\tlet G = G1 + m;\r\n\t\tlet B = B1 + m;\r\n\t\treturn {R, G, B};\r\n\t}\r\n\r\n\tstatic prefs(name: string) {\r\n\t\t// @ts-ignore\r\n\t\tif (window.Storage?.prefs) return Storage.prefs(name);\r\n\t\t// @ts-ignore\r\n\t\tif (window.PS) return PS.prefs[name];\r\n\t\treturn undefined;\r\n\t}\r\n\r\n\tparseChatMessage(\r\n\t\tmessage: string, name: string, timestamp: string, isHighlighted?: boolean\r\n\t): [string, string, boolean?] {\r\n\t\tlet showMe = !BattleLog.prefs('chatformatting')?.hideme;\r\n\t\tlet group = ' ';\r\n\t\tif (!/[A-Za-z0-9]/.test(name.charAt(0))) {\r\n\t\t\t// Backwards compatibility\r\n\t\t\tgroup = name.charAt(0);\r\n\t\t\tname = name.substr(1);\r\n\t\t}\r\n\t\tconst colorStyle = ` style=\"color:${BattleLog.usernameColor(toID(name))}\"`;\r\n\t\tconst clickableName = `<small>${BattleLog.escapeHTML(group)}</small><span class=\"username\" data-name=\"${BattleLog.escapeHTML(name)}\">${BattleLog.escapeHTML(name)}</span>`;\r\n\t\tlet hlClass = isHighlighted ? ' highlighted' : '';\r\n\t\tlet isMine = (window.app?.user?.get('name') === name) || (window.PS?.user.name === name);\r\n\t\tlet mineClass = isMine ? ' mine' : '';\r\n\r\n\t\tlet cmd = '';\r\n\t\tlet target = '';\r\n\t\tif (message.charAt(0) === '/') {\r\n\t\t\tif (message.charAt(1) === '/') {\r\n\t\t\t\tmessage = message.slice(1);\r\n\t\t\t} else {\r\n\t\t\t\tlet spaceIndex = message.indexOf(' ');\r\n\t\t\t\tcmd = (spaceIndex >= 0 ? message.slice(1, spaceIndex) : message.slice(1));\r\n\t\t\t\tif (spaceIndex >= 0) target = message.slice(spaceIndex + 1);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tswitch (cmd) {\r\n\t\tcase 'me':\r\n\t\tcase 'mee':\r\n\t\t\tlet parsedMessage = BattleLog.parseMessage(' ' + target);\r\n\t\t\tif (cmd === 'mee') parsedMessage = parsedMessage.slice(1);\r\n\t\t\tif (!showMe) {\r\n\t\t\t\treturn [\r\n\t\t\t\t\t'chat chatmessage-' + toID(name) + hlClass + mineClass,\r\n\t\t\t\t\t`${timestamp}<strong${colorStyle}>${clickableName}:</strong> <em>/me${parsedMessage}</em>`,\r\n\t\t\t\t];\r\n\t\t\t}\r\n\t\t\treturn [\r\n\t\t\t\t'chat chatmessage-' + toID(name) + hlClass + mineClass,\r\n\t\t\t\t`${timestamp}<em><i><strong${colorStyle}>&bull; ${clickableName}</strong>${parsedMessage}</i></em>`,\r\n\t\t\t];\r\n\t\tcase 'invite':\r\n\t\t\tlet roomid = toRoomid(target);\r\n\t\t\treturn [\r\n\t\t\t\t'chat',\r\n\t\t\t\t`${timestamp}<em>${clickableName} invited you to join the room \"${roomid}\"</em>' +\r\n\t\t\t\t'<div class=\"notice\"><button name=\"joinRoom\" value=\"${roomid}\">Join ${roomid}</button></div>`,\r\n\t\t\t];\r\n\t\tcase 'announce':\r\n\t\t\treturn [\r\n\t\t\t\t'chat chatmessage-' + toID(name) + hlClass + mineClass,\r\n\t\t\t\t`${timestamp}<strong${colorStyle}>${clickableName}:</strong> <span class=\"message-announce\">${BattleLog.parseMessage(target)}</span>`,\r\n\t\t\t];\r\n\t\tcase 'log':\r\n\t\t\treturn [\r\n\t\t\t\t'chat chatmessage-' + toID(name) + hlClass + mineClass,\r\n\t\t\t\t`${timestamp}<span class=\"message-log\">${BattleLog.parseMessage(target)}</span>`,\r\n\t\t\t];\r\n\t\tcase 'data-pokemon':\r\n\t\tcase 'data-item':\r\n\t\tcase 'data-ability':\r\n\t\tcase 'data-move':\r\n\t\t\treturn ['chat message-error', '[outdated code no longer supported]'];\r\n\t\tcase 'text':\r\n\t\t\treturn ['chat', BattleLog.parseMessage(target)];\r\n\t\tcase 'error':\r\n\t\t\treturn ['chat message-error', formatText(target, true)];\r\n\t\tcase 'html':\r\n\t\t\treturn [\r\n\t\t\t\t'chat chatmessage-' + toID(name) + hlClass + mineClass,\r\n\t\t\t\t`${timestamp}<strong${colorStyle}>${clickableName}:</strong> <em>${BattleLog.sanitizeHTML(target)}</em>`,\r\n\t\t\t];\r\n\t\tcase 'uhtml':\r\n\t\tcase 'uhtmlchange':\r\n\t\t\tlet parts = target.split(',');\r\n\t\t\tlet htmlSrc = parts.slice(1).join(',').trim();\r\n\t\t\tthis.changeUhtml(parts[0], htmlSrc, cmd === 'uhtml');\r\n\t\t\treturn ['', ''];\r\n\t\tcase 'raw':\r\n\t\t\treturn ['chat', BattleLog.sanitizeHTML(target)];\r\n\t\tcase 'nonotify':\r\n\t\t\treturn ['chat', BattleLog.sanitizeHTML(target), true];\r\n\t\tdefault:\r\n\t\t\t// Not a command or unsupported. Parsed as a normal chat message.\r\n\t\t\tif (!name) {\r\n\t\t\t\treturn [\r\n\t\t\t\t\t'chat' + hlClass,\r\n\t\t\t\t\t`${timestamp}<em>${BattleLog.parseMessage(message)}</em>`,\r\n\t\t\t\t];\r\n\t\t\t}\r\n\t\t\treturn [\r\n\t\t\t\t'chat chatmessage-' + toID(name) + hlClass + mineClass,\r\n\t\t\t\t`${timestamp}<strong${colorStyle}>${clickableName}:</strong> <em>${BattleLog.parseMessage(message)}</em>`,\r\n\t\t\t];\r\n\t\t}\r\n\t}\r\n\r\n\tstatic parseMessage(str: string, isTrusted = false) {\r\n\t\t// Don't format console commands (>>).\r\n\t\tif (str.substr(0, 3) === '>> ' || str.substr(0, 4) === '>>> ') return this.escapeHTML(str);\r\n\t\t// Don't format console results (<<).\r\n\t\tif (str.substr(0, 3) === '<< ') return this.escapeHTML(str);\r\n\t\tstr = formatText(str, isTrusted);\r\n\r\n\t\tlet options = BattleLog.prefs('chatformatting') || {};\r\n\r\n\t\tif (options.hidelinks) {\r\n\t\t\tstr = str.replace(/<a[^>]*>/g, '<u>').replace(/<\\/a>/g, '</u>');\r\n\t\t}\r\n\t\tif (options.hidespoiler) {\r\n\t\t\tstr = str.replace(/<span class=\"spoiler\">/g, '<span class=\"spoiler spoiler-shown\">');\r\n\t\t}\r\n\t\tif (options.hidegreentext) {\r\n\t\t\tstr = str.replace(/<span class=\"greentext\">/g, '<span>');\r\n\t\t}\r\n\r\n\t\treturn str;\r\n\t}\r\n\r\n\tstatic interstice = (() => {\r\n\t\tconst whitelist: string[] = Config.whitelist;\r\n\t\tconst patterns = whitelist.map(entry => new RegExp(\r\n\t\t\t`^(https?:)?//([A-Za-z0-9-]*\\\\.)?${entry.replace(/\\./g, '\\\\.')}(/.*)?`,\r\n\t\t'i'));\r\n\t\treturn {\r\n\t\t\tisWhitelisted(uri: string) {\r\n\t\t\t\tif (uri[0] === '/' && uri[1] !== '/') {\r\n\t\t\t\t\t// domain-relative URIs are safe\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t}\r\n\t\t\t\tfor (const pattern of patterns) {\r\n\t\t\t\t\tif (pattern.test(uri)) return true;\r\n\t\t\t\t}\r\n\t\t\t\treturn false;\r\n\t\t\t},\r\n\t\t\tgetURI(uri: string) {\r\n\t\t\t\treturn `http://${Config.routes.root}/interstice?uri=${encodeURIComponent(uri)}`;\r\n\t\t\t},\r\n\t\t};\r\n\t})();\r\n\r\n\tstatic tagPolicy: ((tagName: string, attribs: string[]) => any) | null = null;\r\n\tstatic initSanitizeHTML() {\r\n\t\tif (this.tagPolicy) return;\r\n\t\tif (!('html4' in window)) {\r\n\t\t\tthrow new Error('sanitizeHTML requires caja');\r\n\t\t}\r\n\r\n\t\t// By default, Caja will ban any HTML tags it doesn't recognize.\r\n\t\t// Additional HTML tags to allow:\r\n\t\tObject.assign(html4.ELEMENTS, {\r\n\t\t\tmarquee: 0,\r\n\t\t\tblink: 0,\r\n\t\t\tpsicon: html4.eflags['OPTIONAL_ENDTAG'] | html4.eflags['EMPTY'],\r\n\t\t\tusername: 0,\r\n\t\t\tspotify: 0,\r\n\t\t\tyoutube: 0,\r\n\t\t\ttwitch: 0,\r\n\t\t});\r\n\r\n\t\t// By default, Caja will ban any attributes it doesn't recognize.\r\n\t\t// Additional attributes to allow:\r\n\t\tObject.assign(html4.ATTRIBS, {\r\n\t\t\t// See https://developer.mozilla.org/en-US/docs/Web/HTML/Element/marquee\r\n\t\t\t'marquee::behavior': 0,\r\n\t\t\t'marquee::bgcolor': 0,\r\n\t\t\t'marquee::direction': 0,\r\n\t\t\t'marquee::height': 0,\r\n\t\t\t'marquee::hspace': 0,\r\n\t\t\t'marquee::loop': 0,\r\n\t\t\t'marquee::scrollamount': 0,\r\n\t\t\t'marquee::scrolldelay': 0,\r\n\t\t\t'marquee::truespeed': 0,\r\n\t\t\t'marquee::vspace': 0,\r\n\t\t\t'marquee::width': 0,\r\n\t\t\t'psicon::pokemon': 0,\r\n\t\t\t'psicon::item': 0,\r\n\t\t\t'psicon::type': 0,\r\n\t\t\t'psicon::category': 0,\r\n\t\t\t'username::name': 0,\r\n\t\t\t'form::data-submitsend': 0,\r\n\t\t\t'div::data-server': 0,\r\n\t\t\t'button::data-send': 0,\r\n\t\t\t'form::data-delimiter': 0,\r\n\t\t\t'button::data-delimiter': 0,\r\n\t\t\t'*::aria-label': 0,\r\n\t\t\t'*::aria-hidden': 0,\r\n\t\t});\r\n\r\n\t\t// Caja unfortunately doesn't document how `tagPolicy` works, so\r\n\t\t// here's how it goes:\r\n\r\n\t\t// Every opening tag and attributes is filtered through\r\n\t\t// `tagPolicy`, being replaced by the {tagName, attribs} returned.\r\n\t\t// Returning `undefined` means that the tag will be removed entirely.\r\n\r\n\t\t// We run Caja's built-in tag sanitization in the first line of our\r\n\t\t// custom tagPolicy, and its attribs sanitization midway through, with\r\n\t\t// `sanitizeAttribs`.\r\n\r\n\t\t// (n.b. tag contents etc can't be modified in this step.)\r\n\r\n\t\t/**\r\n\t\t * @param tagName Lowercase tag name\r\n\t\t * @param attribs attribs in the form of [key, value, key, value]\r\n\t\t * @return undefined to remove the tag\r\n\t\t */\r\n\t\tthis.tagPolicy = (tagName: string, attribs: string[]) => {\r\n\t\t\tif (html4.ELEMENTS[tagName] & html4.eflags['UNSAFE']) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tfunction getAttrib(key: string) {\r\n\t\t\t\tfor (let i = 0; i < attribs.length - 1; i += 2) {\r\n\t\t\t\t\tif (attribs[i] === key) {\r\n\t\t\t\t\t\treturn attribs[i + 1];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn undefined;\r\n\t\t\t}\r\n\t\t\tfunction setAttrib(key: string, value: string) {\r\n\t\t\t\tfor (let i = 0; i < attribs.length - 1; i += 2) {\r\n\t\t\t\t\tif (attribs[i] === key) {\r\n\t\t\t\t\t\tattribs[i + 1] = value;\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tattribs.push(key, value);\r\n\t\t\t}\r\n\t\t\tfunction deleteAttrib(key: string) {\r\n\t\t\t\tfor (let i = 0; i < attribs.length - 1; i += 2) {\r\n\t\t\t\t\tif (attribs[i] === key) {\r\n\t\t\t\t\t\tattribs.splice(i, 2);\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tlet dataUri = '';\r\n\t\t\tlet targetReplace = false;\r\n\r\n\t\t\tif (tagName === 'a') {\r\n\t\t\t\tif (getAttrib('target') === 'replace') {\r\n\t\t\t\t\ttargetReplace = true;\r\n\t\t\t\t}\r\n\t\t\t} else if (tagName === 'img') {\r\n\t\t\t\tconst src = getAttrib('src') || '';\r\n\t\t\t\tif (src.startsWith('data:image/')) {\r\n\t\t\t\t\tdataUri = src;\r\n\t\t\t\t}\r\n\t\t\t\tif (src.startsWith('//')) {\r\n\t\t\t\t\tif (location.protocol !== 'http:' && location.protocol !== 'https:') {\r\n\t\t\t\t\t\t// in testclient with `file://`, fix src so it still works\r\n\t\t\t\t\t\tsetAttrib('src', 'https:' + src);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} else if (tagName === 'twitch') {\r\n\t\t\t\t// <iframe src=\"https://player.twitch.tv/?channel=ninja&parent=www.example.com\" allowfullscreen=\"true\" height=\"378\" width=\"620\"></iframe>\r\n\t\t\t\tconst src = getAttrib('src') || \"\";\r\n\t\t\t\tconst channelId = /(https?:\\/\\/)?twitch.tv\\/([A-Za-z0-9]+)/i.exec(src)?.[2];\r\n\t\t\t\tconst height = parseInt(getAttrib('height') || \"\", 10) || 400;\r\n\t\t\t\tconst width = parseInt(getAttrib('width') || \"\", 10) || 340;\r\n\t\t\t\treturn {\r\n\t\t\t\t\ttagName: 'iframe',\r\n\t\t\t\t\tattribs: [\r\n\t\t\t\t\t\t'src', `https://player.twitch.tv/?channel=${channelId}&parent=${location.hostname}&autoplay=false`,\r\n\t\t\t\t\t\t'allowfullscreen', 'true', 'height', `${height}`, 'width', `${width}`,\r\n\t\t\t\t\t],\r\n\t\t\t\t};\r\n\t\t\t} else if (tagName === 'username') {\r\n\t\t\t\t// <username> is a custom element that handles namecolors\r\n\t\t\t\ttagName = 'strong';\r\n\t\t\t\tconst color = this.usernameColor(toID(getAttrib('name')));\r\n\t\t\t\tconst style = getAttrib('style');\r\n\t\t\t\tsetAttrib('style', `${style};color:${color}`);\r\n\t\t\t} else if (tagName === 'spotify') {\r\n\t\t\t\t// <iframe src=\"https://open.spotify.com/embed/track/6aSYnCIwcLpnDXngGKAEzZ\" width=\"300\" height=\"380\" frameborder=\"0\" allowtransparency=\"true\" allow=\"encrypted-media\"></iframe>\r\n\t\t\t\tconst src = getAttrib('src') || '';\r\n\t\t\t\tconst songId = /(?:\\?v=|\\/track\\/)([A-Za-z0-9]+)/.exec(src)?.[1];\r\n\r\n\t\t\t\treturn {\r\n\t\t\t\t\ttagName: 'iframe',\r\n\t\t\t\t\tattribs: ['src', `https://open.spotify.com/embed/track/${songId}`, 'width', '300', 'height', '380', 'frameborder', '0', 'allowtransparency', 'true', 'allow', 'encrypted-media'],\r\n\t\t\t\t};\r\n\t\t\t} else if (tagName === 'youtube') {\r\n\t\t\t\t// <iframe width=\"320\" height=\"180\" src=\"https://www.youtube.com/embed/dQw4w9WgXcQ\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\r\n\r\n\t\t\t\tconst src = getAttrib('src') || '';\r\n\t\t\t\t// Google's ToS requires a minimum of 200x200\r\n\t\t\t\tlet width = '320';\r\n\t\t\t\tlet height = '200';\r\n\t\t\t\tif (window.innerWidth >= 400) {\r\n\t\t\t\t\twidth = '400';\r\n\t\t\t\t\theight = '225';\r\n\t\t\t\t}\r\n\t\t\t\tconst videoId = /(?:\\?v=|\\/embed\\/)([A-Za-z0-9_\\-]+)/.exec(src)?.[1];\r\n\t\t\t\tif (!videoId) return {tagName: 'img', attribs: ['alt', `invalid src for <youtube>`]};\r\n\r\n\t\t\t\tconst time = /(?:\\?|&)(?:t|start)=([0-9]+)/.exec(src)?.[1];\r\n\r\n\t\t\t\treturn {\r\n\t\t\t\t\ttagName: 'iframe',\r\n\t\t\t\t\tattribs: [\r\n\t\t\t\t\t\t'width', width, 'height', height,\r\n\t\t\t\t\t\t'src', `https://www.youtube.com/embed/${videoId}${time ? `?start=${time}` : ''}`,\r\n\t\t\t\t\t\t'frameborder', '0', 'allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture', 'allowfullscreen', 'allowfullscreen',\r\n\t\t\t\t\t],\r\n\t\t\t\t};\r\n\t\t\t} else if (tagName === 'psicon') {\r\n\t\t\t\t// <psicon> is a custom element which supports a set of mutually incompatible attributes:\r\n\t\t\t\t// <psicon pokemon> and <psicon item>\r\n\t\t\t\tlet iconType = null;\r\n\t\t\t\tlet iconValue = null;\r\n\t\t\t\tfor (let i = 0; i < attribs.length - 1; i += 2) {\r\n\t\t\t\t\tif (attribs[i] === 'pokemon' || attribs[i] === 'item' || attribs[i] === 'type' || attribs[i] === 'category') {\r\n\t\t\t\t\t\t[iconType, iconValue] = attribs.slice(i, i + 2);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\ttagName = 'span';\r\n\r\n\t\t\t\tif (iconType) {\r\n\t\t\t\t\tconst className = getAttrib('class');\r\n\t\t\t\t\tconst style = getAttrib('style');\r\n\r\n\t\t\t\t\tif (iconType === 'pokemon') {\r\n\t\t\t\t\t\tsetAttrib('class', 'picon' + (className ? ' ' + className : ''));\r\n\t\t\t\t\t\tsetAttrib('style', Dex.getPokemonIcon(iconValue) + (style ? '; ' + style : ''));\r\n\t\t\t\t\t} else if (iconType === 'item') {\r\n\t\t\t\t\t\tsetAttrib('class', 'itemicon' + (className ? ' ' + className : ''));\r\n\t\t\t\t\t\tsetAttrib('style', Dex.getItemIcon(iconValue) + (style ? '; ' + style : ''));\r\n\t\t\t\t\t} else if (iconType === 'type') {\r\n\t\t\t\t\t\ttagName = Dex.getTypeIcon(iconValue).slice(1, -3);\r\n\t\t\t\t\t} else if (iconType === 'category') {\r\n\t\t\t\t\t\ttagName = Dex.getCategoryIcon(iconValue).slice(1, -3);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tattribs = html.sanitizeAttribs(tagName, attribs, (urlData: any) => {\r\n\t\t\t\tif (urlData.scheme_ === 'geo' || urlData.scheme_ === 'sms' || urlData.scheme_ === 'tel') return null;\r\n\t\t\t\treturn urlData;\r\n\t\t\t});\r\n\r\n\t\t\tif (dataUri && tagName === 'img') {\r\n\t\t\t\tsetAttrib('src', dataUri);\r\n\t\t\t}\r\n\t\t\tif (tagName === 'a' || (tagName === 'form' && !getAttrib('data-submitsend'))) {\r\n\t\t\t\tif (targetReplace) {\r\n\t\t\t\t\tsetAttrib('data-target', 'replace');\r\n\t\t\t\t\tdeleteAttrib('target');\r\n\t\t\t\t} else {\r\n\t\t\t\t\tsetAttrib('target', '_blank');\r\n\t\t\t\t}\r\n\t\t\t\tif (tagName === 'a') {\r\n\t\t\t\t\tsetAttrib('rel', 'noopener');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn {tagName, attribs};\r\n\t\t};\r\n\t}\r\n\tstatic localizeTime(full: string, date: string, time: string, timezone?: string) {\r\n\t\tlet parsedTime = new Date(date + 'T' + time + (timezone || 'Z').toUpperCase());\r\n\t\t// Very old (pre-ES5) web browsers may be incapable of parsing ISO 8601\r\n\t\t// dates. In such a case, gracefully continue without replacing the date\r\n\t\t// format.\r\n\t\tif (!parsedTime.getTime()) return full;\r\n\r\n\t\tlet formattedTime;\r\n\t\t// Try using Intl API if it exists\r\n\t\tif ((window as any).Intl?.DateTimeFormat) {\r\n\t\t\tformattedTime = new Intl.DateTimeFormat(undefined, {\r\n\t\t\t\tmonth: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric',\r\n\t\t\t}).format(parsedTime);\r\n\t\t} else {\r\n\t\t\t// toLocaleString even exists in ECMAScript 1, so no need to check\r\n\t\t\t// if it exists.\r\n\t\t\tformattedTime = parsedTime.toLocaleString();\r\n\t\t}\r\n\t\treturn '<time>' + BattleLog.escapeHTML(formattedTime) + '</time>';\r\n\t}\r\n\tstatic sanitizeHTML(input: string) {\r\n\t\tif (typeof input !== 'string') return '';\r\n\r\n\t\tthis.initSanitizeHTML();\r\n\r\n\t\tinput = input.replace(/<username([^>]*)>([^<]*)<\\/username>/gi, (match, attrs, username) => {\r\n\t\t\tif (/\\bname\\s*=\\s*\"/.test(attrs)) return match;\r\n\t\t\tconst escapedUsername = username.replace(/\"/g, '&quot;').replace(/>/g, '&gt;');\r\n\t\t\treturn `<username${attrs} name=\"${escapedUsername}\">${username}</username>`;\r\n\t\t});\r\n\r\n\t\t// Our custom element support happens in `tagPolicy`, which is set\r\n\t\t// up in `initSanitizeHTML` above.\r\n\t\tconst sanitized = html.sanitizeWithPolicy(input, this.tagPolicy) as string;\r\n\r\n\t\t// <time> parsing requires ISO 8601 time. While more time formats are\r\n\t\t// supported by most JavaScript implementations, it isn't required, and\r\n\t\t// how to exactly enforce ignoring user agent timezone setting is not obvious.\r\n\t\t// As dates come from the server which isn't aware of client timezone, a\r\n\t\t// particular timezone is required.\r\n\t\t//\r\n\t\t// This regular expression is split into three groups.\r\n\t\t//\r\n\t\t// Group 1 - date\r\n\t\t// Group 2 - time (seconds and milliseconds are optional)\r\n\t\t// Group 3 - optional timezone\r\n\t\t//\r\n\t\t// Group 1 and group 2 are split to allow using space as a separator\r\n\t\t// instead of T. Stricly speaking ECMAScript 5 specification only\r\n\t\t// allows T, however it's more practical to also allow spaces.\r\n\t\treturn sanitized.replace(\r\n\t\t\t/<time>\\s*([+-]?\\d{4,}-\\d{2}-\\d{2})[T ](\\d{2}:\\d{2}(?::\\d{2}(?:\\.\\d{3})?)?)(Z|[+-]\\d{2}:\\d{2})?\\s*<\\/time>/ig,\r\n\t\tthis.localizeTime);\r\n\t}\r\n\r\n\t/*********************************************************\r\n\t * Replay files\r\n\t *********************************************************/\r\n\r\n\t// Replay files are .html files that display a replay for a battle.\r\n\r\n\t// The .html files mainly contain replay log data; the actual replay\r\n\t// player is downloaded online. Also included is a textual log and\r\n\t// some minimal CSS to make it look pretty, for offline viewing.\r\n\r\n\t// This strategy helps keep the replay file reasonably small; of\r\n\t// the 30 KB or so for a 50-turn battle, around 10 KB is the log\r\n\t// data, and around 20 KB is the textual log.\r\n\r\n\t// The actual replay player is downloaded from replay-embed.js,\r\n\t// which handles loading all the necessary resources for turning the log\r\n\t// data into a playable replay.\r\n\r\n\t// Battle log data is stored in and loaded from a\r\n\t// <script type=\"text/plain\" class=\"battle-log-data\"> tag.\r\n\r\n\t// replay-embed.js is loaded through a cache-buster that rotates daily.\r\n\t// This allows pretty much anything about the replay viewer to be\r\n\t// updated as desired.\r\n\r\n\tstatic createReplayFile(room: any) {\r\n\t\tlet battle = room.battle;\r\n\t\tlet replayid = room.id;\r\n\t\tif (replayid) {\r\n\t\t\t// battle room\r\n\t\t\treplayid = replayid.slice(7);\r\n\t\t\tif (Config.server.id !== 'showdown') {\r\n\t\t\t\tif (!Config.server.registered) {\r\n\t\t\t\t\treplayid = 'unregisteredserver-' + replayid;\r\n\t\t\t\t} else {\r\n\t\t\t\t\treplayid = Config.server.id + '-' + replayid;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// replay panel\r\n\t\t\treplayid = room.fragment;\r\n\t\t}\r\n\t\tbattle.seekTurn(Infinity);\r\n\t\tlet buf = '<!DOCTYPE html>\\n';\r\n\t\tbuf += '<meta charset=\"utf-8\" />\\n';\r\n\t\tbuf += '<!-- version 1 -->\\n';\r\n\t\tbuf += `<title>${BattleLog.escapeHTML(battle.tier)} replay: ${BattleLog.escapeHTML(battle.p1.name)} vs. ${BattleLog.escapeHTML(battle.p2.name)}</title>\\n`;\r\n\t\tbuf += '<style>\\n';\r\n\t\tbuf += 'html,body {font-family:Verdana, sans-serif;font-size:10pt;margin:0;padding:0;}body{padding:12px 0;} .battle-log {font-family:Verdana, sans-serif;font-size:10pt;} .battle-log-inline {border:1px solid #AAAAAA;background:#EEF2F5;color:black;max-width:640px;margin:0 auto 80px;padding-bottom:5px;} .battle-log .inner {padding:4px 8px 0px 8px;} .battle-log .inner-preempt {padding:0 8px 4px 8px;} .battle-log .inner-after {margin-top:0.5em;} .battle-log h2 {margin:0.5em -8px;padding:4px 8px;border:1px solid #AAAAAA;background:#E0E7EA;border-left:0;border-right:0;font-family:Verdana, sans-serif;font-size:13pt;} .battle-log .chat {vertical-align:middle;padding:3px 0 3px 0;font-size:8pt;} .battle-log .chat strong {color:#40576A;} .battle-log .chat em {padding:1px 4px 1px 3px;color:#000000;font-style:normal;} .chat.mine {background:rgba(0,0,0,0.05);margin-left:-8px;margin-right:-8px;padding-left:8px;padding-right:8px;} .spoiler {color:#BBBBBB;background:#BBBBBB;padding:0px 3px;} .spoiler:hover, .spoiler:active, .spoiler-shown {color:#000000;background:#E2E2E2;padding:0px 3px;} .spoiler a {color:#BBBBBB;} .spoiler:hover a, .spoiler:active a, .spoiler-shown a {color:#2288CC;} .chat code, .chat .spoiler:hover code, .chat .spoiler:active code, .chat .spoiler-shown code {border:1px solid #C0C0C0;background:#EEEEEE;color:black;padding:0 2px;} .chat .spoiler code {border:1px solid #CCCCCC;background:#CCCCCC;color:#CCCCCC;} .battle-log .rated {padding:3px 4px;} .battle-log .rated strong {color:white;background:#89A;padding:1px 4px;border-radius:4px;} .spacer {margin-top:0.5em;} .message-announce {background:#6688AA;color:white;padding:1px 4px 2px;} .message-announce a, .broadcast-green a, .broadcast-blue a, .broadcast-red a {color:#DDEEFF;} .broadcast-green {background-color:#559955;color:white;padding:2px 4px;} .broadcast-blue {background-color:#6688AA;color:white;padding:2px 4px;} .infobox {border:1px solid #6688AA;padding:2px 4px;} .infobox-limited {max-height:200px;overflow:auto;overflow-x:hidden;} .broadcast-red {background-color:#AA5544;color:white;padding:2px 4px;} .message-learn-canlearn {font-weight:bold;color:#228822;text-decoration:underline;} .message-learn-cannotlearn {font-weight:bold;color:#CC2222;text-decoration:underline;} .message-effect-weak {font-weight:bold;color:#CC2222;} .message-effect-resist {font-weight:bold;color:#6688AA;} .message-effect-immune {font-weight:bold;color:#666666;} .message-learn-list {margin-top:0;margin-bottom:0;} .message-throttle-notice, .message-error {color:#992222;} .message-overflow, .chat small.message-overflow {font-size:0pt;} .message-overflow::before {font-size:9pt;content:\\'...\\';} .subtle {color:#3A4A66;}\\n';\r\n\t\tbuf += '</style>\\n';\r\n\t\tbuf += '<div class=\"wrapper replay-wrapper\" style=\"max-width:1180px;margin:0 auto\">\\n';\r\n\t\tbuf += '<input type=\"hidden\" name=\"replayid\" value=\"' + replayid + '\" />\\n';\r\n\t\tbuf += '<div class=\"battle\"></div><div class=\"battle-log\"></div><div class=\"replay-controls\"></div><div class=\"replay-controls-2\"></div>\\n';\r\n\t\tbuf += `<h1 style=\"font-weight:normal;text-align:center\"><strong>${BattleLog.escapeHTML(battle.tier)}</strong><br /><a href=\"http://${Config.routes.users}/${toID(battle.p1.name)}\" class=\"subtle\" target=\"_blank\">${BattleLog.escapeHTML(battle.p1.name)}</a> vs. <a href=\"http://${Config.routes.users}/${toID(battle.p2.name)}\" class=\"subtle\" target=\"_blank\">${BattleLog.escapeHTML(battle.p2.name)}</a></h1>\\n`;\r\n\t\tbuf += '<script type=\"text/plain\" class=\"battle-log-data\">' + battle.stepQueue.join('\\n').replace(/\\//g, '\\\\/') + '</script>\\n'; // lgtm [js/incomplete-sanitization]\r\n\t\tbuf += '</div>\\n';\r\n\t\tbuf += '<div class=\"battle-log battle-log-inline\"><div class=\"inner\">' + battle.scene.log.elem.innerHTML + '</div></div>\\n';\r\n\t\tbuf += '</div>\\n';\r\n\t\tbuf += '<script>\\n';\r\n\t\tbuf += `let daily = Math.floor(Date.now()/1000/60/60/24);document.write('<script src=\"https://${Config.routes.client}/js/replay-embed.js?version'+daily+'\"></'+'script>');\\n`;\r\n\t\tbuf += '</script>\\n';\r\n\t\treturn buf;\r\n\t}\r\n\r\n\tstatic createReplayFileHref(room: any) {\r\n\t\t// unescape(encodeURIComponent()) is necessary because btoa doesn't support Unicode\r\n\t\t// @ts-ignore\r\n\t\treturn 'data:text/plain;base64,' + encodeURIComponent(btoa(unescape(encodeURIComponent(BattleLog.createReplayFile(room)))));\r\n\t}\r\n}\r\n"],"file":"battle-log.js"}